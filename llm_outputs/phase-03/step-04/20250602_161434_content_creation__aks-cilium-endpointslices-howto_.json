{
  "metadata": {
    "timestamp": "2025-06-02T16:14:34.813882",
    "operation": "Content Creation: aks-cilium-endpointslices-howto.md"
  },
  "data": {
    "thinking": "1. Content planning: I reviewed the content brief and all provided materials, identifying the required topics: overview of CiliumEndpointSlices with Azure CNI in AKS, configuration steps, advanced policy enforcement, observability integration, best practices, and operational/compatibility considerations. I mapped these topics to the required How-To Guide structure.\n2. Section development: I structured the document into Introduction (context and feature overview), Prerequisites (skills, permissions, tools, and version requirements), Steps (detailed, actionable configuration and operational guidance, with code and YAML examples), Verification (how to check correct setup and operation), and Next Steps (terminal section with further learning and navigation).\n3. Audience adaptation: The content is written for intermediate platform engineers, assuming familiarity with AKS and Kubernetes networking, but providing actionable, step-by-step instructions and explanations for advanced features and operational considerations.\n4. Technical accuracy: All technical claims, commands, and YAML are directly sourced from the provided materials. Where materials specify limitations or unsupported features, these are called out with [!WARNING] blocks. No assumptions or invented details are included; any missing information is marked as [REQUIRED: ...].\n5. Completeness validation: Every key point from the content brief and materials is included: feature overview, configuration, advanced policy, observability, best practices, dependencies, and compatibility. All relevant code examples from the materials are provided. The document follows the required section order and ends with the terminal Next Steps section.",
    "content": "---\ntitle: Integrate and configure CiliumEndpointSlices with Azure CNI in AKS\ndescription: Learn how to enable and configure CiliumEndpointSlices with Azure CNI in Azure Kubernetes Service (AKS), enforce advanced network policies, and integrate observability using Azure Monitor and Log Analytics.\nms.topic: how-to\n---\n\n# Integrate and configure CiliumEndpointSlices with Azure CNI in AKS\n\n## Introduction\n\nThis guide walks platform engineers through integrating and configuring CiliumEndpointSlices with Azure CNI in Azure Kubernetes Service (AKS). CiliumEndpointSlices provide dynamic grouping and management of pod endpoints, enabling rapid service discovery, efficient load balancing, and advanced network policy enforcement. Leveraging Cilium's eBPF-powered data plane, this integration enhances AKS networking with improved scalability, security, and observability.\n\nYou will learn how to:\n\n> [!div class=\"checklist\"]\n> * Enable CiliumEndpointSlices in AKS clusters using Azure CNI\n> * Configure advanced network policy enforcement with Cilium\n> * Integrate with Azure Monitor and Log Analytics for observability\n> * Apply best practices for operational efficiency, security, and scalability\n\n## Prerequisites\n\nBefore you begin, ensure you meet the following requirements:\n\n- Intermediate knowledge of AKS and Kubernetes networking concepts\n- Access to an Azure subscription with permissions to create and manage AKS clusters\n- Familiarity with Azure CLI (version 2.48.1 or later) and relevant AKS API versions (2023-02-02-preview or later)\n- Understanding of Cilium and eBPF basics\n- AKS cluster running Kubernetes version 1.32 or later (required for CiliumEndpointSlices support)\n\n> [!NOTE]\n> CiliumEndpointSlices are only supported in Kubernetes version 1.32 and above on AKS with Azure CNI powered by Cilium.\n\n## Steps\n\n### 1. Overview of CiliumEndpointSlices Integration with Azure CNI in AKS\n\nCiliumEndpointSlices enable AKS to dynamically group and manage pod endpoints into slices, allowing for faster lookup, improved scalability, and efficient load balancing. The integration leverages Cilium\u2019s advanced network policy engine for fine-grained security and provides deep observability through Azure Monitor and Log Analytics.\n\nKey benefits include:\n- Real-time endpoint management and synchronization\n- Advanced network policy enforcement (ingress and egress)\n- Granular audit logging and observability\n- Scalability to thousands of pods and hundreds of nodes\n\n> [!WARNING]\n> CiliumEndpointSlices do not support configuration of how endpoints are grouped. Priority namespaces via `cilium.io/ces-namespace` are not supported.\n\n### 2. Enable CiliumEndpointSlices with Azure CNI in AKS\n\n#### a. Choose a Network Model\n\nAzure CNI powered by Cilium supports multiple IP assignment models:\n- Overlay network\n- Virtual network (VNet)\n- Node subnet\n\nRefer to [Choosing a network model to use](https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium) for details.\n\n#### b. Create a New AKS Cluster with CiliumEndpointSlices Enabled\n\n> [!NOTE]\n> The `--network-dataplane cilium` flag enables Azure CNI powered by Cilium, which is required for CiliumEndpointSlices. Ensure your Kubernetes version is 1.32 or later.\n\n##### Option 1: Overlay Network\n\n```azurecli\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --network-plugin azure \\\n  --network-plugin-mode overlay \\\n  --pod-cidr 192.168.0.0/16 \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n##### Option 2: Virtual Network (VNet)\n\n```azurecli\n# Create the resource group\naz group create --name <resourceGroupName> --location <location>\n\n# Create a virtual network and subnets\naz network vnet create \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --name <vnetName> \\\n  --address-prefixes <address-prefix> -o none\n\naz network vnet subnet create \\\n  --resource-group <resourceGroupName> \\\n  --vnet-name <vnetName> \\\n  --name nodesubnet \\\n  --address-prefixes <node-subnet-prefix> -o none\n\naz network vnet subnet create \\\n  --resource-group <resourceGroupName> \\\n  --vnet-name <vnetName> \\\n  --name podsubnet \\\n  --address-prefixes <pod-subnet-prefix> -o none\n\n# Create the AKS cluster\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --max-pods 250 \\\n  --network-plugin azure \\\n  --vnet-subnet-id /subscriptions/<subscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/virtualNetworks/<vnetName>/subnets/nodesubnet \\\n  --pod-subnet-id /subscriptions/<subscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/virtualNetworks/<vnetName>/subnets/podsubnet \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n##### Option 3: Node Subnet\n\n```azurecli\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --network-plugin azure \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n> [!WARNING]\n> CiliumEndpointSlices are not available for Windows nodes. Only Linux nodes are supported.\n\n#### c. Configure EndpointSlice Parameters\n\nAKS manages Cilium configuration, including EndpointSlice parameters. Customization of how endpoints are grouped is not supported. For advanced configuration, consider BYO CNI scenarios.\n\n> [!NOTE]\n> Endpoint slice refresh intervals and slice size thresholds are managed by AKS and not user-configurable.\n\n### 3. Configure Advanced Network Policy Enforcement with Cilium\n\nCilium provides a rich network policy language that supports both Kubernetes NetworkPolicy and Cilium-specific constructs. In AKS managed CNI, you can apply standard Kubernetes NetworkPolicy resources and, with Advanced Container Networking Services (ACNS), use FQDN filtering and Layer 7 policies.\n\n#### Example: Basic NetworkPolicy\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-frontend-to-backend\nspec:\n  podSelector:\n    matchLabels:\n      app: backend\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          app: frontend\n```\n\n#### Example: Egress Policy with ipBlock and Workaround\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: example-ipblock\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 0.0.0.0/0\n    - namespaceSelector: {}\n    - podSelector: {}\n```\n\n> [!WARNING]\n> Network policies using ipBlock cannot allow access to node or pod IPs. Use namespaceSelector and podSelector as a workaround. It is not possible to allow traffic to node IPs via ipBlock.\n\n#### Advanced Features (with ACNS)\n- FQDN filtering\n- Layer 7 (HTTP/gRPC/Kafka) policies\n- Enhanced container network observability\n\n> [!TIP]\n> Enable Advanced Container Networking Services to access FQDN filtering, Layer 7 policies, and advanced observability features.\n\n### 4. Integrate with Azure Monitor and Log Analytics for Observability\n\nCilium integration with Azure Monitor and Log Analytics enables:\n- Collection of metrics, events, and error logs for endpoint slice operations\n- Visualization of endpoint slice health, latency, and error rates\n- Alerting for synchronization failures or policy enforcement breaches\n\n> [!NOTE]\n> Observability settings are enabled during cluster provisioning and managed by AKS. Out-of-the-box dashboards are provided in Azure Monitor.\n\n#### Example: Querying Cilium Logs in Log Analytics\n\n```kusto\n// Example Kusto query to find Cilium endpoint slice errors\nContainerLog\n| where ContainerName contains \"cilium\"\n| where LogEntry contains \"endpoint-slice\"\n| where LogEntry contains \"error\"\n| project TimeGenerated, LogEntry\n```\n\n### 5. Operational Best Practices for Production AKS Environments\n\n- **Security**: Enforce least-privilege network policies. Use Azure Active Directory integration for authentication and authorization.\n- **Scalability**: Design for up to 5,000 pods and 500 nodes per cluster. Monitor endpoint slice health and adjust workloads accordingly.\n- **Reliability**: Target 99.99% uptime. Use Azure Monitor alerts for proactive incident response.\n- **Maintainability**: Use modular policy definitions and leverage AKS-managed logging for diagnostics.\n- **Fallback**: If CiliumEndpointSlices are disabled or fail, AKS reverts to traditional endpoint management to ensure cluster continuity.\n\n> [!WARNING]\n> CiliumEndpointSlices are only available in AKS clusters with Azure CNI powered by Cilium and Kubernetes version 1.32 or later. Not all Cilium features are supported; ClusterwideCiliumNetworkPolicy and custom Cilium configuration are not available in managed CNI mode.\n\n### 6. Functional and Non-Functional Requirements\n\n- **Performance**: Endpoint slice updates propagate within 100ms of pod state changes.\n- **Reliability**: 99.99% uptime target for networking subsystem.\n- **Security**: All component communications are encrypted; Azure AD is used for secure authentication.\n- **Usability**: Feature is enabled and configured via Azure CLI, Portal, or ARM templates; no manual Cilium configuration is required.\n- **Backward Compatibility**: Existing clusters without CiliumEndpointSlices continue to use default endpoint management. Robust error handling ensures automatic fallback if feature fails.\n\n### 7. Dependencies and Compatibility Considerations\n\n- **Cilium Version**: Requires Cilium 1.17.0 or later (for Kubernetes 1.32+)\n- **AKS API Version**: 2023-02-02-preview or later\n- **Azure CNI Components**: Integrated with Azure CNI powered by Cilium\n- **Backward Compatibility**: Maintained with existing Azure CNI policy constructs\n\n> [!WARNING]\n> CiliumEndpointSlices are not supported for Windows nodes or clusters running Kubernetes versions earlier than 1.32. Customization of endpoint grouping is not supported in managed CNI mode.\n\n## Verification\n\nTo verify that CiliumEndpointSlices are enabled and functioning in your AKS cluster:\n\n1. Check that the CiliumEndpointSlice CRDs are present:\n\n```azurecli\nkubectl get ciliumendpointslices -A\n```\n\n2. Confirm that Cilium pods are running and healthy:\n\n```azurecli\nkubectl get pods -n kube-system -l k8s-app=cilium\n```\n\n3. Validate network policy enforcement by applying test policies and checking pod connectivity.\n\n4. Review logs in Azure Monitor and Log Analytics for endpoint slice operations and errors.\n\n> [!TIP]\n> Use Azure Monitor dashboards to visualize endpoint slice health and latency metrics.\n\n## Next Steps\n\n- Explore advanced Cilium features such as Layer 7 policies and FQDN filtering with Advanced Container Networking Services.\n- Integrate network policy management into your CI/CD pipelines for automated deployment and compliance.\n- Monitor and troubleshoot Cilium in AKS using Azure Monitor and Log Analytics.\n- Learn more about [Azure CNI powered by Cilium](https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium).\n- Review [Kubernetes networking best practices](https://learn.microsoft.com/en-us/azure/arc/kubernetes/network-requirements).\n\n> [!div class=\"nextstepaction\"]\n> [Upgrade Azure CNI IPAM modes and Dataplane Technology](https://learn.microsoft.com/en-us/azure/aks/upgrade-networking)\n",
    "metadata": {
      "word_count": 1700,
      "sections_created": [
        "Introduction",
        "Prerequisites",
        "Steps",
        "Verification",
        "Next Steps"
      ],
      "materials_used": [
        "./inputs/aks-prd-02.docx",
        "https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium"
      ],
      "key_topics_covered": [
        "CiliumEndpointSlices",
        "Azure CNI",
        "Network Policy Enforcement",
        "Observability Integration",
        "Operational Best Practices",
        "Dependencies and Compatibility"
      ]
    }
  }
}