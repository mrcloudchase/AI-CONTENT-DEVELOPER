{
  "metadata": {
    "timestamp": "2025-06-02T15:39:24.416288",
    "operation": "Content Creation: aks-cilium-howto.md"
  },
  "data": {
    "thinking": "To create this how-to guide, I am closely following the provided content brief and the How-To Guide template. I will begin with an Introduction that contextualizes Cilium integration with Azure CNI in AKS, highlighting its benefits (eBPF, scalability, security, observability). The Prerequisites section will clearly list all requirements, including Azure CLI version, permissions, and supported AKS/Cilium versions, as specified in the materials. The Steps section will be detailed, covering deployment on new and existing clusters, CiliumEndpointSlices configuration, Azure Monitor integration, and operational best practices, with warnings and tips as per Microsoft formatting. I will include code examples (Azure CLI, YAML) directly from the materials. Limitations and supported scenarios will be clearly called out with [!WARNING] and [!NOTE] blocks. The Next Steps section will be terminal, offering logical navigation to advanced policy, monitoring, and hybrid scenarios, as directed. All technical details are strictly sourced from the provided materials, and any missing information will be noted. The document will be structured for intermediate platform engineers, balancing clarity and technical depth.",
    "content": "---\ntitle: Deploy and configure Cilium with Azure CNI in AKS\ndescription: Learn how to deploy, configure, and operate Azure CNI powered by Cilium in Azure Kubernetes Service (AKS), including advanced features such as CiliumEndpointSlices, enhanced network policy enforcement, and integration with Azure Monitor.\nms.topic: how-to\n---\n\n# Deploy and configure Cilium with Azure CNI in AKS\n\n## Introduction\n\nAzure CNI powered by Cilium brings advanced networking capabilities to Azure Kubernetes Service (AKS) by combining the robust Azure CNI control plane with Cilium's high-performance eBPF data plane. This integration enables dynamic endpoint management, enhanced network policy enforcement, and improved observability, making it ideal for platform engineers managing scalable, secure, and efficient Kubernetes environments.\n\nWith CiliumEndpointSlices, AKS clusters benefit from dynamic grouping of pod endpoints, enabling rapid service discovery, efficient load balancing, and granular security controls. Integration with Azure Monitor and Cilium observability tools further enhances operational insight and troubleshooting capabilities.\n\n> [!NOTE]\n> Cilium on AKS is currently supported only on Linux nodes. Ensure your cluster meets all prerequisites before proceeding.\n\n## Prerequisites\n\nBefore deploying or configuring Azure CNI powered by Cilium in AKS, ensure the following:\n\n- **Familiarity with AKS and Kubernetes networking concepts**\n- **Azure CLI** version 2.48.1 or later installed and authenticated\n- **Access to an Azure subscription** with permissions to create and manage AKS clusters\n- **Supported AKS and Cilium versions**:\n  - Kubernetes 1.27 (LTS): Cilium 1.13.18+\n  - Kubernetes 1.28: Cilium 1.13.18+\n  - Kubernetes 1.29: Cilium 1.14.19+\n  - Kubernetes 1.30 (LTS): Cilium 1.14.19+\n  - Kubernetes 1.31: Cilium 1.16.6+\n  - Kubernetes 1.32: Cilium 1.17.0+\n- **Linux-based AKS node pools only** (Windows nodes are not supported)\n- **AKS API version** 2022-09-02-preview or later if using ARM templates or REST API\n\n> [!WARNING]\n> Azure CNI powered by Cilium is not available for Windows nodes. Network policies using `ipBlock` have limitations\u2014see Limitations below.\n\n## Steps\n\n### 1. Choose a Pod IP Assignment Method\nAzure CNI powered by Cilium supports multiple modes for assigning pod IPs:\n- **Overlay network** (similar to Azure CNI Overlay)\n- **Virtual network** (dynamic pod IP assignment)\n- **Node subnet**\n\n#### [Overlay Network](#tab/overlay)\nCreate a new AKS cluster with Cilium and overlay networking:\n\n```azurecli\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --network-plugin azure \\\n  --network-plugin-mode overlay \\\n  --pod-cidr 192.168.0.0/16 \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n> [!NOTE]\n> The `--network-dataplane cilium` flag replaces the deprecated `--enable-ebpf-dataplane` flag.\n\n#### [Virtual Network](#tab/vnet)\nProvision a virtual network and subnets, then create the AKS cluster:\n\n```azurecli\n# Create the resource group\naz group create --name <resourceGroupName> --location <location>\n\n# Create a virtual network with node and pod subnets\naz network vnet create --resource-group <resourceGroupName> --location <location> --name <vnetName> --address-prefixes <vnetAddressPrefix> -o none\naz network vnet subnet create --resource-group <resourceGroupName> --vnet-name <vnetName> --name nodesubnet --address-prefixes <nodeSubnetPrefix> -o none\naz network vnet subnet create --resource-group <resourceGroupName> --vnet-name <vnetName> --name podsubnet --address-prefixes <podSubnetPrefix> -o none\n\n# Create the AKS cluster\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --max-pods 250 \\\n  --network-plugin azure \\\n  --vnet-subnet-id /subscriptions/<subscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/virtualNetworks/<vnetName>/subnets/nodesubnet \\\n  --pod-subnet-id /subscriptions/<subscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/virtualNetworks/<vnetName>/subnets/podsubnet \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n#### [Node Subnet](#tab/nodesubnet)\nCreate a cluster using the node subnet with Cilium:\n\n```azurecli\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --network-plugin azure \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n---\n\n### 2. Enable CiliumEndpointSlices\nCiliumEndpointSlices are supported in Kubernetes 1.32 and above. They provide scalable, dynamic grouping of pod endpoints for efficient service discovery and policy enforcement.\n\n> [!NOTE]\n> CiliumEndpointSlices do not support custom grouping configuration or priority namespaces via `cilium.io/ces-namespace`.\n\nNo manual configuration is required to enable CiliumEndpointSlices if your cluster is running a supported version. Endpoint slices are managed automatically by Cilium and AKS.\n\n#### Example: Viewing CiliumEndpointSlices\n```bash\nkubectl get ciliumepslices -A\n```\n\n### 3. Configure Network Policies with Cilium\nCilium enforces Kubernetes NetworkPolicy resources natively. You can define policies for fine-grained control over pod communication.\n\n#### Example: Basic NetworkPolicy\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-frontend\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      app: frontend\n  policyTypes:\n  - Ingress\n  ingress:\n  - from:\n    - podSelector:\n        matchLabels:\n          app: backend\n```\n\n> [!WARNING]\n> Network policies using `ipBlock` cannot select pod or node IPs. To allow traffic to all pods, use `namespaceSelector` and `podSelector` instead.\n\n#### Example: Workaround for ipBlock Limitation\n```yaml\napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-all-egress\nspec:\n  podSelector: {}\n  policyTypes:\n  - Egress\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 0.0.0.0/0\n    - namespaceSelector: {}\n    - podSelector: {}\n```\n\n### 4. Integrate with Azure Monitor and Cilium Observability\nCilium provides detailed logging, metrics, and diagnostics. Integration with Azure Monitor and Log Analytics enables proactive troubleshooting and performance tuning.\n\n- Enable advanced container networking services for observability features (metrics, flow logs, FQDN filtering, Layer 7 policies).\n- Configure Log Analytics workspace and connect it to your AKS cluster as per standard Azure Monitor integration steps.\n\n> [!NOTE]\n> Out-of-the-box dashboards visualize endpoint slice health, latency, and error rates. Alerts can be configured for synchronization failures or policy enforcement breaches.\n\n### 5. Operational Best Practices\n- **Scalability:** Azure CNI powered by Cilium supports up to 5,000 pods across 500 nodes per cluster.\n- **Reliability:** Target 99.99% uptime for networking subsystems.\n- **Fallback:** If CiliumEndpointSlices fail, AKS reverts to traditional endpoint management automatically.\n- **Security:** All component communications are encrypted and integrate with Azure Active Directory.\n- **Maintainability:** Use robust error handling and monitor logs for diagnostics.\n\n> [!TIP]\n> For production environments, regularly review Azure Monitor dashboards and configure alerts for critical networking events.\n\n### 6. Limitations and Supported Scenarios\n- **Linux-only:** Cilium is not supported on Windows nodes.\n- **ipBlock Restrictions:** Network policies using `ipBlock` cannot allow traffic to pod or node IPs.\n- **No kube-proxy:** Clusters with Cilium dataplane do not use kube-proxy.\n- **No manual Cilium configuration:** AKS manages Cilium configuration; for custom setups, use BYO CNI.\n- **CiliumEndpointSlices:** Supported in Kubernetes 1.32+; grouping configuration is not customizable.\n- **No support for ClusterwideCiliumNetworkPolicy.**\n\n## Verification\n\nAfter deployment, verify that Cilium and endpoint slices are functioning:\n\n```bash\nkubectl get pods -n kube-system -l k8s-app=cilium\nkubectl get ciliumepslices -A\n```\n\nCheck Azure Monitor dashboards for networking metrics and alerts.\n\n## Next Steps\n\n- [Implement advanced network policies using Cilium](https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium)\n- [Monitor and troubleshoot Cilium-powered networking in AKS](https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium)\n- [Explore multi-cloud or hybrid scenarios with Cilium and Azure Arc](/articles/azure-arc/kubernetes/network-requirements.md)\n- [Use GitOps with Flux v2 for AKS configuration management](/articles/azure-arc/kubernetes/tutorial-use-gitops-flux2.md)\n\n> [!div class=\"nextstepaction\"]\n> [Learn more about AKS networking and Cilium integration](https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium)\n",
    "metadata": {
      "word_count": 1560,
      "sections_created": [
        "Introduction",
        "Prerequisites",
        "Steps",
        "Verification",
        "Next Steps"
      ],
      "materials_used": [
        "./inputs/aks-prd-02.docx",
        "https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium"
      ],
      "key_topics_covered": [
        "Cilium",
        "Azure CNI",
        "CiliumEndpointSlices",
        "Network Policy Enforcement",
        "Azure Monitor Integration",
        "Operational Best Practices",
        "Limitations"
      ]
    }
  }
}