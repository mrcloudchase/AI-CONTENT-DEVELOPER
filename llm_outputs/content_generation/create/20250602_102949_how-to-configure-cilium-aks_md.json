{
  "metadata": {
    "timestamp": "2025-06-02T10:29:49.871587",
    "operation": "create_content"
  },
  "data": {
    "thinking": "To create this how-to guide, I first mapped the content brief requirements to the provided materials. The main topics\u2014Cilium integration with Azure CNI in AKS, enabling CiliumEndpointSlices, configuration, validation, lifecycle management, and troubleshooting\u2014are all addressed in the PRD and the Microsoft Learn article. I will begin with an Introduction that summarizes Cilium's role and benefits. The Prerequisites section will clearly state required skills, tools, and permissions. The Steps section will be detailed, covering new and existing cluster scenarios, enabling Cilium, configuring CiliumEndpointSlices, and best practices for lifecycle management. I'll include warnings and notes as specified. The Verification section will show how to validate Cilium and CiliumEndpointSlices, using CLI and YAML examples. The Next Steps terminal section will guide readers to advanced features, GitOps integration, and monitoring, as per the brief. All code examples and warnings will use Microsoft documentation formatting. I will ensure the document flows logically and that the terminal section is last, as required.",
    "content": "---\ntitle: Configure Cilium with Azure CNI in AKS\ndescription: Learn how to enable, configure, and validate Cilium as the network plugin for Azure CNI in Azure Kubernetes Service (AKS), including CiliumEndpointSlices management.\nms.topic: how-to\n---\n\n# Configure Cilium with Azure CNI in AKS\n\n## Introduction\n\nCilium is an advanced networking and security plugin that leverages eBPF technology to provide high-performance networking, dynamic endpoint management, and fine-grained network policy enforcement in Kubernetes environments. When integrated with Azure CNI in Azure Kubernetes Service (AKS), Cilium enhances service discovery, scalability, observability, and security. This guide provides step-by-step instructions for platform engineers to enable and configure Cilium\u2014including CiliumEndpointSlices\u2014in AKS clusters, along with best practices for lifecycle management and troubleshooting.\n\n> [!NOTE]\n> CiliumEndpointSlices are supported in AKS clusters running Kubernetes version 1.32 and above with Azure CNI powered by Cilium. This feature is available only for Linux-based clusters.\n\n## Prerequisites\n\n- Familiarity with AKS cluster management and Kubernetes networking concepts\n- [Azure CLI](https://learn.microsoft.com/cli/azure/install-azure-cli) version 2.48.1 or later, installed and configured\n- Access to an Azure subscription with permissions to create and modify AKS clusters\n- For advanced configuration or troubleshooting, access to the Azure portal and Kubernetes YAML editing tools\n\n> [!WARNING]\n> Before changing the network plugin or enabling Cilium, ensure your cluster version is compatible and back up all critical workloads and configurations. Changing network plugins can impact existing workloads and may require downtime.\n\n## Steps\n\n### 1. Understand Cilium and Azure CNI Integration\n\nAzure CNI powered by Cilium combines Azure's robust control plane with Cilium's eBPF-based data plane. This integration provides:\n- Dynamic endpoint management with CiliumEndpointSlices for efficient service discovery and load balancing\n- Advanced network policy enforcement using Cilium's policy engine\n- Enhanced observability and diagnostics via Azure Monitor and Cilium tools\n- Support for large-scale clusters with improved scalability and reliability\n\n> [!TIP]\n> Cilium replaces kube-proxy in AKS clusters using Azure CNI powered by Cilium, simplifying network policy management and improving performance.\n\n### 2. Enable Cilium in a New AKS Cluster\n\nYou can enable Cilium as the network dataplane during AKS cluster creation using the Azure CLI. Choose the appropriate IP assignment method for your environment.\n\n#### Option 1: Overlay Network\n\n```azurecli\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --network-plugin azure \\\n  --network-plugin-mode overlay \\\n  --pod-cidr 192.168.0.0/16 \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n#### Option 2: Virtual Network (VNet) Assignment\n\n```azurecli\n# Create resource group and virtual network\naz group create --name <resourceGroupName> --location <location>\naz network vnet create --resource-group <resourceGroupName> --location <location> --name <vnetName> --address-prefixes <addressPrefix>\naz network vnet subnet create --resource-group <resourceGroupName> --vnet-name <vnetName> --name nodesubnet --address-prefixes <nodeSubnetPrefix>\naz network vnet subnet create --resource-group <resourceGroupName> --vnet-name <vnetName> --name podsubnet --address-prefixes <podSubnetPrefix>\n\n# Create AKS cluster with Cilium\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --max-pods 250 \\\n  --network-plugin azure \\\n  --vnet-subnet-id /subscriptions/<subscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/virtualNetworks/<vnetName>/subnets/nodesubnet \\\n  --pod-subnet-id /subscriptions/<subscriptionId>/resourceGroups/<resourceGroupName>/providers/Microsoft.Network/virtualNetworks/<vnetName>/subnets/podsubnet \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n#### Option 3: Node Subnet Assignment\n\n```azurecli\naz aks create \\\n  --name <clusterName> \\\n  --resource-group <resourceGroupName> \\\n  --location <location> \\\n  --network-plugin azure \\\n  --network-dataplane cilium \\\n  --generate-ssh-keys\n```\n\n> [!NOTE]\n> The `--network-dataplane cilium` flag enables Azure CNI powered by Cilium. This replaces the deprecated `--enable-ebpf-dataplane` flag.\n\n### 3. Enable Cilium in an Existing AKS Cluster\n\nCurrently, AKS manages the Cilium configuration, and direct modification of Cilium settings is not supported. To migrate an existing cluster to use Cilium, upgrade the cluster to a supported Kubernetes version and use the Azure CLI to update the network dataplane. Refer to the [agent-upgrade.md](agent-upgrade.md) guide for upgrade procedures.\n\n> [!WARNING]\n> Migrating to Cilium may impact running workloads. Test the migration in a staging environment and ensure you have a rollback plan.\n\n### 4. Configure and Validate CiliumEndpointSlices\n\nCiliumEndpointSlices are automatically managed in AKS clusters with Cilium enabled (Kubernetes 1.32+). Manual configuration of how endpoints are grouped is not supported; AKS handles grouping and synchronization.\n\nTo view CiliumEndpointSlices:\n\n```azurecli\nkubectl get ciliumendpointslices -A\n```\n\nTo inspect a specific CiliumEndpointSlice:\n\n```azurecli\nkubectl get ciliumendpointslice <slice-name> -n <namespace> -o yaml\n```\n\n> [!NOTE]\n> CiliumEndpointSlices do not support configuration of grouping logic or priority namespaces in AKS. All management is handled by the platform.\n\n#### Example: CiliumEndpointSlice YAML\n\n```yaml\napiVersion: cilium.io/v2alpha1\nkind: CiliumEndpointSlice\nmetadata:\n  name: <slice-name>\n  namespace: <namespace>\nspec:\n  endpoints:\n    - name: <endpoint-name>\n      ... # Endpoint details managed by AKS\n```\n\n> [!TIP]\n> Use the Azure portal's YAML editor to view or troubleshoot CiliumEndpointSlices, but avoid making direct production changes. For production, use GitOps workflows. See [kubernetes-resource-view.md](kubernetes-resource-view.md) for details.\n\n### 5. Best Practices for Managing Cilium Lifecycle and Upgrades\n\n- Monitor AKS release notes for supported Cilium and Kubernetes versions.\n- Use the Azure CLI and portal for upgrades; do not attempt to manually upgrade Cilium components.\n- Integrate with Azure Monitor and Log Analytics for observability of network traffic and endpoint slice health.\n- Regularly review network policies and audit logs to ensure compliance and security.\n- For production environments, use GitOps to manage network policy and resource configurations.\n\n### 6. Troubleshooting Common Issues\n\n- **Network Policy Enforcement:**\n  - Cilium enforces network policies natively. ipBlock-based policies cannot select pod or node IPs. Use `namespaceSelector` and `podSelector` as a workaround.\n  - Example workaround:\n    ```yaml\n    apiVersion: networking.k8s.io/v1\n    kind: NetworkPolicy\n    metadata:\n      name: allow-egress\n    spec:\n      podSelector: {}\n      policyTypes:\n      - Egress\n      egress:\n      - to:\n        - ipBlock:\n            cidr: 0.0.0.0/0\n        - namespaceSelector: {}\n        - podSelector: {}\n    ```\n- **Observability:**\n  - Enable Azure Monitor integration for metrics and logs.\n  - Use Cilium's built-in observability tools for deeper diagnostics.\n- **Compatibility:**\n  - Cilium is supported only on Linux nodes in AKS.\n  - Ensure your cluster is running a supported Kubernetes version (1.32+ for CiliumEndpointSlices).\n\n> [!WARNING]\n> Do not edit or override Cilium configuration directly in managed AKS clusters. For advanced scenarios, consider AKS BYO CNI with manual Cilium installation.\n\n## Verification\n\nAfter enabling Cilium and deploying your AKS cluster, verify the status of Cilium and CiliumEndpointSlices:\n\n```azurecli\n# Check Cilium pods\nkubectl get pods -n kube-system -l k8s-app=cilium\n\n# List CiliumEndpointSlices\nkubectl get ciliumendpointslices -A\n\n# View network policies\nkubectl get networkpolicies -A\n```\n\nCheck logs for Cilium components:\n\n```azurecli\nkubectl logs -n kube-system -l k8s-app=cilium\n```\n\n> [!TIP]\n> Use Azure Monitor dashboards to visualize endpoint slice health, latency, and error rates for proactive troubleshooting.\n\n## Next Steps\n\n- Explore advanced Cilium features such as network policies and observability tools.\n- Integrate Cilium configuration and policies with GitOps workflows using Flux for production-grade automation.\n- Monitor and upgrade Cilium in production environments following AKS best practices. See [agent-upgrade.md](agent-upgrade.md) for upgrade guidance.\n- Learn how to edit Kubernetes resources safely in the Azure portal in [kubernetes-resource-view.md](kubernetes-resource-view.md).\n\n> [!div class=\"nextstepaction\"]\n> [Learn more about AKS networking and Cilium integration](https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium)\n",
    "metadata": {
      "word_count": 1530,
      "sections_created": [
        "Introduction",
        "Prerequisites",
        "Steps",
        "Verification",
        "Next Steps"
      ],
      "materials_used": [
        "./inputs/aks-prd-02.docx",
        "https://learn.microsoft.com/en-us/azure/aks/azure-cni-powered-by-cilium",
        "agent-upgrade.md",
        "kubernetes-resource-view.md"
      ],
      "key_topics_covered": [
        "Cilium",
        "Azure CNI",
        "CiliumEndpointSlices",
        "Network Policy Enforcement",
        "AKS Cluster Management",
        "Observability",
        "Lifecycle Management",
        "Troubleshooting"
      ]
    }
  }
}